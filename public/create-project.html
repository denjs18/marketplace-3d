<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cr√©er un projet - Marketplace 3D</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="/" class="nav-logo">Marketplace 3D</a>
      <div class="nav-menu">
        <span>Chargement...</span>
      </div>
    </div>
  </nav>

  <div class="container" style="max-width: 900px; margin-top: 2rem;">
    <h1 class="mb-3">Cr√©er un nouveau projet</h1>

    <div id="alert-container"></div>

    <form id="project-form" enctype="multipart/form-data">
      <!-- Informations g√©n√©rales -->
      <div class="card mb-3">
        <div class="card-header">
          <h2 class="card-title">Informations du projet</h2>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label class="form-label" for="title">Titre du projet *</label>
            <input type="text" class="form-input" id="title" required placeholder="Ex: Support tablette pour voiture">
          </div>

          <div class="form-group">
            <label class="form-label" for="description">Description *</label>
            <textarea class="form-textarea" id="description" required placeholder="D√©crivez votre projet en d√©tail..."></textarea>
          </div>
        </div>
      </div>

      <!-- Upload fichier STL -->
      <div class="card mb-3">
        <div class="card-header">
          <h2 class="card-title">Fichier 3D</h2>
        </div>
        <div class="card-body">
          <div class="form-group">
            <label class="form-label">Fichier 3D (STL, OBJ, 3MF) - Max 50MB *</label>
            <div class="upload-area" id="upload-area">
              <input type="file" id="stlFile" name="stlFile" accept=".stl,.obj,.3mf" style="display: none;" required>
              <div id="upload-prompt">
                <p style="font-size: 3rem; margin-bottom: 1rem;">üìÅ</p>
                <p><strong>Cliquez pour s√©lectionner</strong> ou glissez-d√©posez votre fichier</p>
                <p class="text-secondary">Formats accept√©s : STL, OBJ, 3MF</p>
              </div>
              <div id="file-info" class="hidden">
                <p style="font-size: 2rem; margin-bottom: 0.5rem;">‚úì</p>
                <p id="file-name" class="text-success"></p>
                <p id="file-size" class="text-secondary"></p>
                <button type="button" class="btn btn-outline mt-2" id="change-file">Changer de fichier</button>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Sp√©cifications -->
      <div class="card mb-3">
        <div class="card-header">
          <h2 class="card-title">Sp√©cifications d'impression</h2>
        </div>
        <div class="card-body">
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label" for="material">Mat√©riau souhait√© *</label>
              <select class="form-select form-input" id="material" required>
                <option value="">Choisir...</option>
                <option value="PLA">PLA (Standard)</option>
                <option value="ABS">ABS (R√©sistant)</option>
                <option value="PETG">PETG (Flexible/R√©sistant)</option>
                <option value="Resin">R√©sine (Haute pr√©cision)</option>
                <option value="Nylon">Nylon (Ultra-r√©sistant)</option>
                <option value="TPU">TPU (Souple)</option>
                <option value="Other">Autre</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="color">Couleur souhait√©e</label>
              <input type="text" class="form-input" id="color" placeholder="Ex: Noir, Blanc, Rouge...">
            </div>

            <div class="form-group">
              <label class="form-label" for="quantity">Quantit√© *</label>
              <input type="number" class="form-input" id="quantity" min="1" value="1" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="infill">Remplissage (%)</label>
              <input type="number" class="form-input" id="infill" min="0" max="100" value="20">
              <small class="text-secondary">20% = Standard, 100% = Solide</small>
            </div>

            <div class="form-group">
              <label class="form-label" for="postProcessing">Finition</label>
              <select class="form-select form-input" id="postProcessing">
                <option value="None">Aucune</option>
                <option value="Sanding">Pon√ßage</option>
                <option value="Painting">Peinture</option>
                <option value="Assembly">Assemblage</option>
                <option value="Other">Autre</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label" for="layerHeight">Hauteur de couche (mm)</label>
              <input type="number" class="form-input" id="layerHeight" step="0.01" value="0.2">
              <small class="text-secondary">0.2mm = Standard, 0.1mm = Haute qualit√©</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Budget et d√©lai -->
      <div class="card mb-3">
        <div class="card-header">
          <h2 class="card-title">Budget et d√©lai (optionnel)</h2>
        </div>
        <div class="card-body">
          <div class="grid grid-2">
            <div class="form-group">
              <label class="form-label" for="budgetMin">Budget minimum (‚Ç¨)</label>
              <input type="number" class="form-input" id="budgetMin" min="0" step="0.01" placeholder="Ex: 50">
            </div>

            <div class="form-group">
              <label class="form-label" for="budgetMax">Budget maximum (‚Ç¨)</label>
              <input type="number" class="form-input" id="budgetMax" min="0" step="0.01" placeholder="Ex: 100">
            </div>

            <div class="form-group">
              <label class="form-label" for="deadline">D√©lai souhait√©</label>
              <input type="date" class="form-input" id="deadline">
            </div>
          </div>

        </div>
      </div>

      <!-- Actions -->
      <div class="flex gap-2">
        <button type="button" class="btn btn-outline" onclick="window.location.href='/dashboard-client.html'">Annuler</button>
        <button type="submit" class="btn btn-primary" style="flex: 1;">
          <span id="submit-text">Publier le projet</span>
          <span id="submit-loading" class="loading hidden"></span>
        </button>
      </div>
    </form>
  </div>

  <script src="/js/auth.js"></script>
  <script src="/js/app.js"></script>
  <script>
    let currentUser = null;

    // Initialisation avec authentification
    document.addEventListener('DOMContentLoaded', async () => {
      currentUser = await requireAuth('client');
      if (!currentUser) {
        return;
      }

      createAuthNavbar(currentUser);

      // Check if editing existing project
      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');
      if (projectId) {
        await loadProject(projectId);
        document.querySelector('h1').textContent = 'Modifier le projet';
        document.getElementById('submit-text').textContent = 'Sauvegarder les modifications';
      }
    });

    // Charger un projet existant pour modification
    async function loadProject(projectId) {
      const token = getToken();

      try {
        const response = await fetch(`/api/projects/${projectId}`, {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!response.ok) {
          throw new Error('Erreur lors du chargement du projet');
        }

        const data = await response.json();
        const project = data.project;

        // Remplir le formulaire
        document.getElementById('title').value = project.title;
        document.getElementById('description').value = project.description;
        document.getElementById('material').value = project.material || '';
        document.getElementById('color').value = project.color || '';
        document.getElementById('quantity').value = project.quantity || 1;
        document.getElementById('infill').value = project.infill || 20;
        document.getElementById('postProcessing').value = project.finish || 'None';
        document.getElementById('layerHeight').value = project.layerHeight || 0.2;

        if (project.estimatedBudget) {
          document.getElementById('budgetMax').value = project.estimatedBudget;
        }

        if (project.deadline) {
          document.getElementById('deadline').value = project.deadline.split('T')[0];
        }

        // Le fichier STL ne peut pas √™tre pr√©-rempli pour des raisons de s√©curit√©
        fileInput.removeAttribute('required');
      } catch (error) {
        console.error('Erreur:', error);
        showToast('Erreur lors du chargement du projet', 'error');
      }
    }


    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('stlFile');
    const uploadPrompt = document.getElementById('upload-prompt');
    const fileInfo = document.getElementById('file-info');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const changeFileBtn = document.getElementById('change-file');
    const previewContainer = document.getElementById('preview-container');
    let selectedFile = null;

    // Upload area click
    uploadArea.addEventListener('click', () => {
      if (!fileInfo.classList.contains('hidden')) return;
      fileInput.click();
    });

    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
      uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadArea.classList.remove('dragover');
      const file = e.dataTransfer.files[0];
      if (file) handleFileSelect(file);
    });

    // File input change
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleFileSelect(file);
    });

    // Change file button
    changeFileBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      fileInput.value = '';
      fileInput.click();
    });

    function handleFileSelect(file) {
      // Validate file type
      const ext = file.name.split('.').pop().toLowerCase();
      if (!['stl', 'obj', '3mf'].includes(ext)) {
        alert('Format de fichier non support√©. Utilisez STL, OBJ ou 3MF.');
        return;
      }

      // Validate file size (50MB)
      if (file.size > 50 * 1024 * 1024) {
        alert('Le fichier est trop volumineux. Maximum 50MB.');
        return;
      }

      selectedFile = file;
      fileName.textContent = file.name;
      fileSize.textContent = formatFileSize(file.size);

      uploadPrompt.classList.add('hidden');
      fileInfo.classList.remove('hidden');
    }

    // Form submission
    document.getElementById('project-form').addEventListener('submit', async (e) => {
      e.preventDefault();

      const urlParams = new URLSearchParams(window.location.search);
      const projectId = urlParams.get('id');

      // Pour la modification, le fichier STL est optionnel
      if (!projectId && !selectedFile) {
        showToast('Veuillez s√©lectionner un fichier 3D', 'error');
        return;
      }

      const submitText = document.getElementById('submit-text');
      const submitLoading = document.getElementById('submit-loading');
      const alertContainer = document.getElementById('alert-container');

      submitText.classList.add('hidden');
      submitLoading.classList.remove('hidden');
      alertContainer.innerHTML = '';

      try {
        const token = getToken();

        // √âtape 1: Upload du fichier STL si pr√©sent
        let stlFileUrl = null;
        if (selectedFile) {
          const stlFormData = new FormData();
          stlFormData.append('stlFile', selectedFile);

          const uploadResponse = await fetch('/api/uploads/stl', {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: stlFormData
          });

          if (!uploadResponse.ok) {
            throw new Error('Erreur lors de l\'upload du fichier STL');
          }

          const uploadData = await uploadResponse.json();
          stlFileUrl = uploadData.stlFile;
        }

        // √âtape 2: Cr√©er ou mettre √† jour le projet
        const projectData = {
          title: document.getElementById('title').value,
          description: document.getElementById('description').value,
          material: document.getElementById('material').value,
          color: document.getElementById('color').value || 'Natural',
          quantity: parseInt(document.getElementById('quantity').value),
          infill: parseInt(document.getElementById('infill').value) || 20,
          finish: document.getElementById('postProcessing').value,
          layerHeight: parseFloat(document.getElementById('layerHeight').value) || 0.2,
          estimatedBudget: parseFloat(document.getElementById('budgetMax').value) || 0,
          deadline: document.getElementById('deadline').value || null,
          projectStatus: 'draft' // Commence en brouillon
        };

        if (stlFileUrl) {
          projectData.stlFile = stlFileUrl;
        }

        const method = projectId ? 'PUT' : 'POST';
        const endpoint = projectId ? `/api/projects/${projectId}` : '/api/projects';

        const response = await fetch(endpoint, {
          method: method,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(projectData)
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Erreur lors de la sauvegarde du projet');
        }

        const data = await response.json();

        showToast(projectId ? 'Projet modifi√© avec succ√®s!' : 'Projet cr√©√© avec succ√®s!', 'success');

        setTimeout(() => {
          window.location.href = '/dashboard-client.html';
        }, 1500);

      } catch (error) {
        console.error('Erreur:', error);
        showToast(error.message || 'Erreur lors de la sauvegarde du projet', 'error');

        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    });
  </script>
</body>
</html>
