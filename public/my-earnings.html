<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mes Revenus - Marketplace 3D</title>
  <link rel="stylesheet" href="/css/styles.css">
  <style>
    .earnings-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin: 30px 0;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .stat-icon {
      font-size: 32px;
      margin-bottom: 12px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #0984e3;
      margin-bottom: 8px;
    }

    .stat-label {
      font-size: 14px;
      color: #636e72;
      font-weight: 500;
    }

    .transactions-table {
      background: white;
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      margin-top: 30px;
    }

    .table {
      width: 100%;
      border-collapse: collapse;
    }

    .table th {
      text-align: left;
      padding: 12px;
      border-bottom: 2px solid #eee;
      font-weight: 600;
      color: #2d3436;
    }

    .table td {
      padding: 12px;
      border-bottom: 1px solid #eee;
    }

    .table tr:hover {
      background: #f8f9fa;
    }

    .amount-positive {
      color: #00b894;
      font-weight: 600;
    }

    .amount-negative {
      color: #d63031;
      font-weight: 600;
    }

    .status-badge {
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
    }

    .status-completed {
      background: #d5f4e6;
      color: #00b894;
    }

    .status-pending {
      background: #ffeaa7;
      color: #fdcb6e;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    .info-box {
      background: #e3f2fd;
      border-left: 4px solid #0984e3;
      padding: 16px;
      border-radius: 8px;
      margin-bottom: 20px;
    }

    .info-box h3 {
      margin: 0 0 8px 0;
      color: #0984e3;
      font-size: 16px;
    }

    .info-box p {
      margin: 0;
      font-size: 14px;
      color: #2d3436;
    }
  </style>
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="/" class="nav-logo">Marketplace 3D</a>
      <div class="nav-menu">
        <a href="/dashboard-printer.html" class="nav-link">Tableau de bord</a>
        <a href="#" id="logoutBtn" class="nav-link">D√©connexion</a>
      </div>
    </div>
  </nav>

  <div class="earnings-container">
    <h1>Mes Revenus</h1>

    <div class="info-box">
      <h3>üí° Commission de la plateforme</h3>
      <p>La plateforme pr√©l√®ve une commission de 10% sur chaque transaction. Les montants affich√©s sont apr√®s d√©duction de la commission.</p>
    </div>

    <div id="loading" style="text-align: center; padding: 40px;">
      Chargement des revenus...
    </div>

    <div id="statsSection" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üí∞</div>
          <div class="stat-value" id="totalEarnings">0 ‚Ç¨</div>
          <div class="stat-label">Revenus totaux</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üìÖ</div>
          <div class="stat-value" id="monthEarnings">0 ‚Ç¨</div>
          <div class="stat-label">Revenus ce mois</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">üìä</div>
          <div class="stat-value" id="projectsCompleted">0</div>
          <div class="stat-label">Projets termin√©s</div>
        </div>

        <div class="stat-card">
          <div class="stat-icon">‚è≥</div>
          <div class="stat-value" id="pendingPayouts">0 ‚Ç¨</div>
          <div class="stat-label">En attente de paiement</div>
        </div>
      </div>

      <div class="transactions-table">
        <h2 style="margin-bottom: 20px;">Historique des transactions</h2>
        <div id="transactionsContent"></div>
      </div>
    </div>

    <div id="emptyState" class="empty-state" style="display: none;">
      <div class="empty-state-icon">üí∞</div>
      <h2>Aucun revenu pour le moment</h2>
      <p>Vos revenus appara√Ætront ici une fois que vous aurez compl√©t√© des projets</p>
      <button class="btn btn-primary" onclick="window.location.href='/available-projects.html'" style="margin-top: 20px; padding: 12px 24px; background: #0984e3; color: white; border: none; border-radius: 8px; cursor: pointer;">
        Voir les projets disponibles
      </button>
    </div>
  </div>

  <script>
    // Charger les revenus
    async function loadEarnings() {
      const token = localStorage.getItem('token');

      try {
        // Charger le profil de l'utilisateur
        const profileResponse = await fetch('/api/users/profile', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!profileResponse.ok) {
          throw new Error('Erreur lors du chargement du profil');
        }

        const user = await profileResponse.json();

        // Charger les conversations compl√©t√©es
        const conversationsResponse = await fetch('/api/conversations/my-conversations?status=completed', {
          headers: { 'Authorization': `Bearer ${token}` }
        });

        if (!conversationsResponse.ok) {
          throw new Error('Erreur lors du chargement des conversations');
        }

        const conversationsData = await conversationsResponse.json();
        const completedConversations = conversationsData.conversations || [];

        document.getElementById('loading').style.display = 'none';

        // Calculer les statistiques
        let totalEarnings = 0;
        let monthEarnings = 0;
        const now = new Date();
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

        completedConversations.forEach(conv => {
          if (conv.currentQuote && conv.currentQuote.totalPrice) {
            const earningsAfterCommission = conv.currentQuote.totalPrice * 0.9; // 10% commission
            totalEarnings += earningsAfterCommission;

            if (new Date(conv.updatedAt) >= firstDayOfMonth) {
              monthEarnings += earningsAfterCommission;
            }
          }
        });

        // Afficher les stats
        document.getElementById('totalEarnings').textContent = totalEarnings.toFixed(2) + ' ‚Ç¨';
        document.getElementById('monthEarnings').textContent = monthEarnings.toFixed(2) + ' ‚Ç¨';
        document.getElementById('projectsCompleted').textContent = completedConversations.length;
        document.getElementById('pendingPayouts').textContent = '0 ‚Ç¨'; // √Ä impl√©menter avec les vraies transactions

        // Afficher les transactions
        if (completedConversations.length === 0) {
          document.getElementById('emptyState').style.display = 'block';
        } else {
          document.getElementById('statsSection').style.display = 'block';
          displayTransactions(completedConversations);
        }
      } catch (error) {
        console.error('Error loading earnings:', error);
        document.getElementById('loading').innerHTML = '<p style="color: red;">Erreur lors du chargement des revenus</p>';
      }
    }

    // Afficher les transactions
    function displayTransactions(conversations) {
      const content = document.getElementById('transactionsContent');

      if (conversations.length === 0) {
        content.innerHTML = '<p style="text-align: center; color: #999;">Aucune transaction</p>';
        return;
      }

      const rows = conversations.map(conv => {
        const quote = conv.currentQuote;
        const project = conv.project;
        const totalPrice = quote ? quote.totalPrice : 0;
        const commission = totalPrice * 0.1;
        const earnings = totalPrice * 0.9;

        return `
          <tr>
            <td>${new Date(conv.updatedAt).toLocaleDateString('fr-FR')}</td>
            <td>${project.title}</td>
            <td>${conv.client.firstName} ${conv.client.lastName}</td>
            <td>${totalPrice.toFixed(2)} ‚Ç¨</td>
            <td style="color: #d63031;">-${commission.toFixed(2)} ‚Ç¨</td>
            <td class="amount-positive">+${earnings.toFixed(2)} ‚Ç¨</td>
            <td><span class="status-badge status-completed">Termin√©</span></td>
          </tr>
        `;
      }).join('');

      content.innerHTML = `
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Projet</th>
              <th>Client</th>
              <th>Montant total</th>
              <th>Commission (10%)</th>
              <th>Revenus</th>
              <th>Statut</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      `;
    }

    // D√©connexion
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }

    // Charger au d√©marrage
    document.addEventListener('DOMContentLoaded', () => {
      const token = localStorage.getItem('token');
      if (!token) {
        window.location.href = '/login.html';
        return;
      }

      document.getElementById('logoutBtn').addEventListener('click', logout);
      loadEarnings();
    });
  </script>
</body>
</html>
