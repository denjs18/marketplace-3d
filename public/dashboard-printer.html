<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard Imprimeur - Strivex</title>
  <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
  <nav class="navbar">
    <div class="nav-container">
      <a href="/" class="logo">Strivex</a>
      <div class="flex gap-2">
        <span id="user-name" class="badge badge-success">Chargement...</span>
        <button class="btn btn-outline" onclick="logout()">D√©connexion</button>
      </div>
    </div>
  </nav>

  <div class="dashboard">
    <aside class="sidebar">
      <h3 class="mb-3">Menu Imprimeur</h3>
      <ul class="sidebar-nav">
        <li><a href="#" class="active">üìä Tableau de bord</a></li>
        <li><a href="#">üîç Projets disponibles</a></li>
        <li><a href="#">üìù Mes devis</a></li>
        <li><a href="#">üí¨ Messages</a></li>
        <li><a href="#">üí∞ Revenus</a></li>
        <li><a href="#">üë§ Mon profil</a></li>
      </ul>
    </aside>

    <main class="dashboard-content">
      <h1 class="mb-3">Dashboard Imprimeur</h1>

      <!-- Business Status Section -->
      <div id="business-status-section" class="card mb-3" style="display: none;">
        <div class="card-header">
          <h2 class="card-title">üìã Statut Professionnel</h2>
        </div>
        <div class="card-body">
          <div id="business-status-content">
            <!-- Will be dynamically populated -->
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div id="loading-stats" class="text-center mb-3">
        <p>Chargement des statistiques...</p>
      </div>
      <div id="stats-grid" class="stats-grid hidden">
        <div class="stat-card">
          <div id="stat-available" class="stat-value">0</div>
          <div class="stat-label">Projets disponibles</div>
        </div>
        <div class="stat-card">
          <div id="stat-quotes" class="stat-value">0</div>
          <div class="stat-label">Devis envoy√©s</div>
        </div>
        <div class="stat-card">
          <div id="stat-active" class="stat-value">0</div>
          <div class="stat-label">Projets actifs</div>
        </div>
        <div class="stat-card">
          <div id="stat-revenue" class="stat-value">0 ‚Ç¨</div>
          <div class="stat-label">Revenus ce mois</div>
        </div>
      </div>

      <!-- Actions rapides -->
      <div class="card mb-3">
        <div class="card-header">
          <h2 class="card-title">Actions rapides</h2>
        </div>
        <div class="card-body">
          <div class="flex gap-2">
            <button class="btn btn-primary" onclick="window.location.href='/available-projects.html'">
              üîç Voir projets disponibles
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='/messages.html'">
              üí¨ Messages
            </button>
            <button class="btn btn-secondary" onclick="window.location.href='/profile.html'">
              üë§ Mon profil
            </button>
          </div>
        </div>
      </div>

      <!-- Nouveaux projets disponibles -->
      <div class="card mb-3">
        <div class="card-header">
          <h2 class="card-title">Nouveaux projets disponibles</h2>
        </div>
        <div class="card-body">
          <div id="loading-available-projects" class="text-center">
            <p>Chargement des projets...</p>
          </div>
          <div id="available-projects-grid" class="grid grid-2 hidden">
            <!-- Projects will be loaded dynamically -->
          </div>
          <div id="no-available-projects" class="text-center text-secondary hidden">
            <p>Aucun projet disponible pour le moment.</p>
          </div>
        </div>
      </div>

      <!-- Mes devis en cours -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Mes devis en attente</h2>
        </div>
        <div class="card-body">
          <div id="loading-my-quotes" class="text-center">
            <p>Chargement des devis...</p>
          </div>
          <div id="my-quotes-table" class="hidden">
            <table class="table">
              <thead>
                <tr>
                  <th>Projet</th>
                  <th>Client</th>
                  <th>Mon prix</th>
                  <th>D√©lai propos√©</th>
                  <th>Statut</th>
                  <th>Date</th>
                </tr>
              </thead>
              <tbody id="my-quotes-body">
                <!-- Quotes will be loaded dynamically -->
              </tbody>
            </table>
          </div>
          <div id="no-my-quotes" class="text-center text-secondary hidden">
            <p>Aucun devis envoy√© pour le moment.</p>
          </div>
        </div>
      </div>

      <!-- Projets en cours -->
      <div class="card mt-3">
        <div class="card-header">
          <h2 class="card-title">Projets en cours d'impression</h2>
        </div>
        <div class="card-body">
          <div id="loading-progress-projects" class="text-center">
            <p>Chargement des projets...</p>
          </div>
          <div id="progress-projects-grid" class="grid grid-2 hidden">
            <!-- Projects in progress will be loaded dynamically -->
          </div>
          <div id="no-progress-projects" class="text-center text-secondary hidden">
            <p>Aucun projet en cours d'impression.</p>
          </div>
        </div>
      </div>

      <!-- Statistiques revenus -->
      <div class="card mt-3">
        <div class="card-header">
          <h2 class="card-title">Aper√ßu des revenus</h2>
        </div>
        <div class="card-body">
          <div id="loading-revenue" class="text-center">
            <p>Chargement des revenus...</p>
          </div>
          <div id="revenue-stats" class="hidden">
            <div class="grid grid-3">
              <div class="text-center">
                <div id="revenue-month" class="stat-value text-success">0 ‚Ç¨</div>
                <div class="stat-label">Ce mois-ci</div>
              </div>
              <div class="text-center">
                <div id="revenue-year" class="stat-value text-primary">0 ‚Ç¨</div>
                <div class="stat-label">Total ann√©e</div>
              </div>
              <div class="text-center">
                <div id="completed-count" class="stat-value text-secondary">0</div>
                <div class="stat-label">Projets termin√©s</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Modal for upgrading to business status -->
  <div id="upgrade-modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div style="background-color: white; margin: 5% auto; padding: 0; border-radius: 10px; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <div style="padding: 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0;">Passer en micro-entrepreneur</h2>
        <span onclick="closeUpgradeModal()" style="cursor: pointer; font-size: 28px; font-weight: bold; color: #aaa;">&times;</span>
      </div>
      <div style="padding: 20px;">
        <p class="mb-3">Pour continuer √† vendre sur la plateforme, vous devez cr√©er une micro-entreprise et renseigner votre num√©ro SIRET.</p>

        <form id="upgrade-form" onsubmit="submitUpgrade(event)">
          <div class="form-group mb-3">
            <label for="business-status-select" style="display: block; margin-bottom: 5px; font-weight: bold;">Statut *</label>
            <select id="business-status-select" name="businessStatus" class="form-control" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
              <option value="">S√©lectionnez un statut</option>
              <option value="micro-entrepreneur">Micro-entrepreneur</option>
              <option value="professionnel">Professionnel (SARL, SAS, etc.)</option>
            </select>
          </div>

          <div class="form-group mb-3">
            <label for="siret-input" style="display: block; margin-bottom: 5px; font-weight: bold;">Num√©ro SIRET (14 chiffres) *</label>
            <input type="text" id="siret-input" name="siret" class="form-control"
                   pattern="\d{14}" maxlength="14"
                   placeholder="12345678900012" required style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <small class="text-secondary">Le SIRET doit contenir exactement 14 chiffres</small>
          </div>

          <div class="form-group mb-3">
            <label for="tva-input" style="display: block; margin-bottom: 5px; font-weight: bold;">Num√©ro de TVA intracommunautaire (optionnel)</label>
            <input type="text" id="tva-input" name="tva" class="form-control"
                   placeholder="FR12345678901" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
            <small class="text-secondary">Obligatoire uniquement si vous √™tes assujetti √† la TVA</small>
          </div>

          <div class="form-group mb-3">
            <label style="display: block;">
              <input type="checkbox" required style="margin-right: 5px;">
              Je certifie √™tre en r√®gle avec l'administration fiscale et sociale
            </label>
          </div>

          <div id="upgrade-error" class="alert alert-danger" style="display: none; padding: 10px; background-color: #f8d7da; color: #721c24; border-radius: 5px; margin-bottom: 15px;"></div>

          <div class="flex gap-2 justify-end" style="display: flex; gap: 10px; justify-content: flex-end;">
            <button type="button" class="btn btn-secondary" onclick="closeUpgradeModal()" style="padding: 10px 20px; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Annuler</button>
            <button type="submit" class="btn btn-primary" style="padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer;">Valider mon statut</button>
          </div>
        </form>

        <div class="mt-3" style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
          <p><strong>Vous n'avez pas encore cr√©√© votre micro-entreprise ?</strong></p>
          <a href="/guide-microentreprise.html" target="_blank" class="btn btn-outline" style="display: inline-block; padding: 10px 20px; background-color: white; color: #007bff; border: 2px solid #007bff; border-radius: 5px; text-decoration: none; margin-top: 10px;">
            üìñ Consulter le guide de cr√©ation
          </a>
        </div>
      </div>
    </div>
  </div>

  <script src="/js/app.js"></script>
  <script src="/js/auth.js"></script>
  <script>
    // Check authentication
    if (!requireAuth('printer')) {
      // Will redirect if not authenticated or wrong role
    }

    // Load user info
    const user = JSON.parse(localStorage.getItem('user'));
    document.getElementById('user-name').textContent = user.name || user.email;

    // Logout function
    function logout() {
      localStorage.removeItem('token');
      localStorage.removeItem('refreshToken');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }

    // Get auth token
    function getAuthToken() {
      return localStorage.getItem('token');
    }

    // API call with authentication
    async function apiCall(endpoint, options = {}) {
      const token = getAuthToken();
      const defaultOptions = {
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`
        }
      };

      const response = await fetch(endpoint, { ...defaultOptions, ...options });

      if (response.status === 401) {
        const refreshed = await refreshToken();
        if (refreshed) {
          const newToken = getAuthToken();
          defaultOptions.headers.Authorization = `Bearer ${newToken}`;
          return fetch(endpoint, { ...defaultOptions, ...options });
        } else {
          logout();
          return null;
        }
      }

      return response;
    }

    // Business status functions
    async function loadBusinessStatus() {
      try {
        const response = await apiCall('/api/users/sales-statistics');
        if (response && response.ok) {
          const data = await response.json();
          displayBusinessStatus(data.statistics);
        }
      } catch (error) {
        console.error('Error loading business status:', error);
      }
    }

    function displayBusinessStatus(stats) {
      const section = document.getElementById('business-status-section');
      const content = document.getElementById('business-status-content');

      if (!stats) return;

      // Always show for particulier status
      if (stats.businessStatus === 'particulier') {
        section.style.display = 'block';

        const revenuePercent = stats.revenueUsagePercent || 0;
        const transactionPercent = stats.transactionUsagePercent || 0;
        const isWarning = revenuePercent >= 80 || transactionPercent >= 80;
        const isBlocked = stats.accountBlocked;

        let statusHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
              <span class="badge" style="background-color: #28a745; color: white; padding: 5px 10px; border-radius: 5px; font-size: 14px;">
                Particulier
              </span>
            </div>
            ${!isBlocked ? '<button class="btn btn-primary" onclick="openUpgradeModal()">Passer en micro-entrepreneur</button>' : ''}
          </div>
          <p style="margin-bottom: 15px;">Vous pouvez vendre jusqu'√† <strong>3 000 ‚Ç¨</strong> ou <strong>20 transactions</strong> par an en tant que particulier.</p>
        `;

        if (isBlocked) {
          statusHTML += `
            <div class="alert alert-danger" style="background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin-bottom: 20px;">
              <strong>üö´ Compte bloqu√©</strong>
              <p style="margin-top: 10px;">${stats.blockReason || 'Vous avez d√©pass√© les seuils l√©gaux.'}</p>
              <button class="btn btn-primary" onclick="openUpgradeModal()" style="margin-top: 10px;">D√©bloquer mon compte</button>
            </div>
          `;
        } else if (isWarning) {
          statusHTML += `
            <div class="alert alert-warning" style="background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin-bottom: 20px;">
              <strong>‚ö†Ô∏è Attention !</strong> Vous approchez du seuil l√©gal.
            </div>
          `;
        }

        // Revenue progress bar
        statusHTML += `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span><strong>Chiffre d'affaires annuel</strong></span>
              <span>${stats.yearlyRevenue?.toFixed(2) || 0} ‚Ç¨ / 3 000 ‚Ç¨</span>
            </div>
            <div style="width: 100%; height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden;">
              <div style="width: ${Math.min(100, revenuePercent)}%; height: 100%; background-color: ${isBlocked ? '#dc3545' : isWarning ? '#ffc107' : '#28a745'}; transition: width 0.3s;"></div>
            </div>
            <small>${revenuePercent.toFixed(1)}% utilis√©</small>
          </div>
        `;

        // Transaction progress bar
        statusHTML += `
          <div style="margin-bottom: 20px;">
            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
              <span><strong>Transactions annuelles</strong></span>
              <span>${stats.yearlyTransactionCount || 0} / 20</span>
            </div>
            <div style="width: 100%; height: 20px; background-color: #e0e0e0; border-radius: 10px; overflow: hidden;">
              <div style="width: ${Math.min(100, transactionPercent)}%; height: 100%; background-color: ${isBlocked ? '#dc3545' : isWarning ? '#ffc107' : '#28a745'}; transition: width 0.3s;"></div>
            </div>
            <small>${transactionPercent.toFixed(1)}% utilis√©</small>
          </div>
        `;

        content.innerHTML = statusHTML;
      } else {
        // Show professional status
        section.style.display = 'block';
        const statusLabel = stats.businessStatus === 'micro-entrepreneur' ? 'Micro-entrepreneur' : 'Professionnel';
        content.innerHTML = `
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <span class="badge" style="background-color: #007bff; color: white; padding: 5px 10px; border-radius: 5px; font-size: 14px;">
                ${statusLabel}
              </span>
              <p style="margin-top: 10px; color: #666;">Aucune limitation de vente</p>
            </div>
          </div>
        `;
      }
    }

    function openUpgradeModal() {
      document.getElementById('upgrade-modal').style.display = 'block';
    }

    function closeUpgradeModal() {
      document.getElementById('upgrade-modal').style.display = 'none';
      document.getElementById('upgrade-form').reset();
      document.getElementById('upgrade-error').style.display = 'none';
    }

    async function submitUpgrade(event) {
      event.preventDefault();

      const form = event.target;
      const formData = new FormData(form);
      const data = {
        siret: formData.get('siret'),
        businessStatus: formData.get('businessStatus'),
        tva: formData.get('tva')
      };

      const errorDiv = document.getElementById('upgrade-error');
      errorDiv.style.display = 'none';

      try {
        const response = await apiCall('/api/users/upgrade-to-business', {
          method: 'PUT',
          body: JSON.stringify(data)
        });

        if (response && response.ok) {
          alert('Statut professionnel mis √† jour avec succ√®s ! Votre compte est maintenant d√©bloqu√©.');
          closeUpgradeModal();
          // Reload page to reflect changes
          window.location.reload();
        } else {
          const error = await response.json();
          errorDiv.textContent = error.error || 'Erreur lors de la mise √† jour';
          errorDiv.style.display = 'block';
        }
      } catch (error) {
        console.error('Error upgrading business status:', error);
        errorDiv.textContent = 'Erreur de connexion au serveur';
        errorDiv.style.display = 'block';
      }
    }

    // Load dashboard data
    async function loadDashboard() {
      await Promise.all([
        loadBusinessStatus(),
        loadStats(),
        loadAvailableProjects(),
        loadMyQuotes(),
        loadProgressProjects(),
        loadRevenue()
      ]);
    }

    // Load stats
    async function loadStats() {
      try {
        // Load available projects count
        const availableResponse = await apiCall('/api/projects?status=active');
        const availableData = await availableResponse.json();
        const availableCount = availableData.projects?.length || 0;

        // Load my quotes count
        const quotesResponse = await apiCall('/api/quotes/printer');
        const quotesData = await quotesResponse.json();
        const quotesCount = quotesData.quotes?.length || 0;

        // Load active projects (accepted quotes)
        const activeQuotes = quotesData.quotes?.filter(q => q.status === 'accepted') || [];
        const activeCount = activeQuotes.length;

        // Calculate revenue (simplified - should come from backend)
        const monthRevenue = activeQuotes
          .filter(q => new Date(q.createdAt).getMonth() === new Date().getMonth())
          .reduce((sum, q) => sum + (q.price * 0.9), 0);

        document.getElementById('stat-available').textContent = availableCount;
        document.getElementById('stat-quotes').textContent = quotesCount;
        document.getElementById('stat-active').textContent = activeCount;
        document.getElementById('stat-revenue').textContent = monthRevenue.toFixed(2) + ' ‚Ç¨';

        document.getElementById('loading-stats').classList.add('hidden');
        document.getElementById('stats-grid').classList.remove('hidden');
      } catch (error) {
        console.error('Error loading stats:', error);
        document.getElementById('loading-stats').innerHTML = '<p class="text-danger">Erreur de chargement</p>';
      }
    }

    // Load available projects
    async function loadAvailableProjects() {
      try {
        const response = await apiCall('/api/projects?limit=4');
        if (response && response.ok) {
          const data = await response.json();
          let projects = data.projects || [];

          // Filter only published projects
          projects = projects.filter(p => p.projectStatus === 'published');

          document.getElementById('loading-available-projects').classList.add('hidden');

          if (projects.length === 0) {
            document.getElementById('no-available-projects').classList.remove('hidden');
          } else {
            const grid = document.getElementById('available-projects-grid');
            grid.innerHTML = projects.map(project => {
              const material = project.specifications?.material || 'Non sp√©cifi√©';
              const quantity = project.specifications?.quantity || 1;
              const budget = project.budget?.max || 0;
              const deadline = project.deadline ? new Date(project.deadline).toLocaleDateString('fr-FR') : 'Non d√©fini';

              return `
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">${project.title}</h3>
                    <span class="badge badge-info">Nouveau</span>
                  </div>
                  <div class="card-body">
                    <p class="text-secondary mb-2">${project.description.substring(0, 60)}${project.description.length > 60 ? '...' : ''}</p>
                    <div class="mb-2">
                      <span class="badge badge-info">${material}</span>
                      <span class="badge badge-warning">Quantit√©: ${quantity}</span>
                    </div>
                    <div class="flex-between mb-2">
                      <span><strong>Budget max:</strong> ${budget} ‚Ç¨</span>
                      <span><strong>D√©lai:</strong> ${deadline}</span>
                    </div>
                    <button class="btn btn-primary btn-full" onclick="window.location.href='/project-details.html?id=${project._id}'">Voir d√©tails</button>
                  </div>
                </div>
              `;
            }).join('');
            grid.classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('Error loading available projects:', error);
        document.getElementById('loading-available-projects').innerHTML = '<p class="text-danger">Erreur de chargement</p>';
      }
    }

    // Load my quotes
    async function loadMyQuotes() {
      try {
        const response = await apiCall('/api/quotes/printer');
        if (response && response.ok) {
          const data = await response.json();
          const quotes = data.quotes || [];

          document.getElementById('loading-my-quotes').classList.add('hidden');

          if (quotes.length === 0) {
            document.getElementById('no-my-quotes').classList.remove('hidden');
          } else {
            const tbody = document.getElementById('my-quotes-body');
            tbody.innerHTML = quotes.slice(0, 5).map(quote => {
              const statusBadges = {
                'pending': 'badge-warning',
                'accepted': 'badge-success',
                'rejected': 'badge-danger',
                'expired': 'badge-secondary'
              };
              const statusLabels = {
                'pending': 'En attente',
                'accepted': 'Accept√© ‚úì',
                'rejected': 'Refus√©',
                'expired': 'Expir√©'
              };

              const createdDate = new Date(quote.createdAt).toLocaleDateString('fr-FR');

              return `
                <tr>
                  <td><strong>${quote.project?.title || 'Projet supprim√©'}</strong></td>
                  <td>${quote.project?.client?.name || 'Client'}</td>
                  <td><strong>${quote.price.toFixed(2)} ‚Ç¨</strong></td>
                  <td>${quote.estimatedDuration.value} ${quote.estimatedDuration.unit === 'days' ? 'jours' : quote.estimatedDuration.unit === 'hours' ? 'heures' : 'semaines'}</td>
                  <td><span class="badge ${statusBadges[quote.status]}">${statusLabels[quote.status]}</span></td>
                  <td>${createdDate}</td>
                </tr>
              `;
            }).join('');
            document.getElementById('my-quotes-table').classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('Error loading my quotes:', error);
        document.getElementById('loading-my-quotes').innerHTML = '<p class="text-danger">Erreur de chargement</p>';
      }
    }

    // Load projects in progress
    async function loadProgressProjects() {
      try {
        const response = await apiCall('/api/projects?status=in_progress&limit=4');
        if (response && response.ok) {
          const data = await response.json();
          const projects = data.projects || [];

          document.getElementById('loading-progress-projects').classList.add('hidden');

          if (projects.length === 0) {
            document.getElementById('no-progress-projects').classList.remove('hidden');
          } else {
            const grid = document.getElementById('progress-projects-grid');
            grid.innerHTML = projects.map(project => {
              const clientPayment = (project.acceptedQuote?.price * 0.9).toFixed(2);
              return `
                <div class="card">
                  <div class="card-header">
                    <h3 class="card-title">${project.title}</h3>
                    <span class="badge badge-warning">En cours</span>
                  </div>
                  <div class="card-body">
                    <p class="text-secondary mb-2">${project.description.substring(0, 60)}${project.description.length > 60 ? '...' : ''}</p>
                    <div class="mb-2">
                      <strong>Client:</strong> ${project.client?.name || 'Client'}<br>
                      <strong>Votre paiement:</strong> ${clientPayment} ‚Ç¨
                    </div>
                    <button class="btn btn-secondary btn-full" onclick="completeProject('${project._id}')">Marquer comme termin√©</button>
                  </div>
                </div>
              `;
            }).join('');
            grid.classList.remove('hidden');
          }
        }
      } catch (error) {
        console.error('Error loading progress projects:', error);
        document.getElementById('loading-progress-projects').innerHTML = '<p class="text-danger">Erreur de chargement</p>';
      }
    }

    // Load revenue
    async function loadRevenue() {
      try {
        const response = await apiCall('/api/payments/earnings');
        if (response && response.ok) {
          const data = await response.json();

          document.getElementById('revenue-month').textContent = (data.monthlyEarnings || 0).toFixed(2) + ' ‚Ç¨';
          document.getElementById('revenue-year').textContent = (data.yearlyEarnings || 0).toFixed(2) + ' ‚Ç¨';
          document.getElementById('completed-count').textContent = data.completedProjects || 0;

          document.getElementById('loading-revenue').classList.add('hidden');
          document.getElementById('revenue-stats').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Error loading revenue:', error);
        // Use default values on error
        document.getElementById('loading-revenue').classList.add('hidden');
        document.getElementById('revenue-stats').classList.remove('hidden');
      }
    }

    // Submit quote
    function submitQuote(projectId) {
      window.location.href = `/submit-quote.html?project=${projectId}`;
    }

    // Complete project
    async function completeProject(projectId) {
      if (!confirm('Marquer ce projet comme termin√© ?')) {
        return;
      }

      try {
        const response = await apiCall(`/api/projects/${projectId}/complete`, {
          method: 'POST'
        });

        if (response && response.ok) {
          alert('Projet marqu√© comme termin√© ! Le paiement sera trait√©.');
          window.location.reload();
        } else {
          const error = await response.json();
          alert('Erreur : ' + (error.message || 'Impossible de terminer le projet'));
        }
      } catch (error) {
        console.error('Error completing project:', error);
        alert('Erreur de connexion au serveur');
      }
    }

    // Initialize dashboard
    loadDashboard();
  </script>
</body>
</html>
